// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Note: This User model is no longer used for authentication.
// Authentication is handled by neon_auth.admin_users table.
// This model is kept for potential future use or historical data.
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Manufacturer {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  releases  Release[]
}

model Release {
  id             String          @id @default(cuid())
  name           String
  year           String?
  slug           String          @unique
  description    String?         // Brief summary displayed in previews and on release page
  releaseDate    DateTime?       // Official release date for display (nullable for backwards compatibility)

  // Approval workflow
  isApproved     Boolean         @default(false) // Whether release is approved for public viewing
  approvedAt     DateTime?       // When the release was approved
  approvedBy     String?         // Email of admin who approved it

  // Source files used for AI analysis
  sellSheetText  String?         @db.Text // Extracted text from sell sheets for AI description generation
  sourceFiles    Json?           // Array of {url: string, type: string, filename: string} for uploaded PDFs/images

  manufacturerId String
  manufacturer   Manufacturer    @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  sets           Set[]
  posts          Post[]          // Posts that reference this release
  images         Image[]
  sourceDocuments ReleaseSourceDocument[]
}

model Set {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL-friendly slug - required for public access
  type        SetType  @default(Base) // Base, Autograph, Memorabilia, or Insert
  isBaseSet   Boolean  @default(false) // Deprecated: use type field instead
  releaseId   String
  release     Release  @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  totalCards  String?
  printRun    Int?     // Standard print run for this set (e.g., 99 for "/99" parallels, null for unlimited base sets)
  description String?  // Optional description for this set

  // Source data for regeneration and reference
  sourceText  String?  @db.Text // Original pasted checklist text (parent sets only)

  parallels   Json?    // DEPRECATED: Array of {name: string, printRun: string} - use parallelSets relation instead

  // Parent-child relationship for parallel sets
  parentSetId String?  // Reference to parent set (null for parent sets)
  parentSet   Set?     @relation("ParallelSets", fields: [parentSetId], references: [id], onDelete: Cascade)
  parallelSets Set[]   @relation("ParallelSets") // Child parallel sets of this parent

  // Flags for parallel behavior
  hasVariableChecklist Boolean @default(false) // True if parallels have different checklists (e.g., "or fewer")
  mirrorsParentChecklist Boolean @default(true) // True if parallel cards should mirror parent set's checklist

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  cards       Card[]
  posts       Post[]   // Posts that reference this set
  images      Image[]
}

enum SetType {
  Base
  Autograph
  Memorabilia
  Insert
}

model Card {
  id                    String   @id @default(cuid())
  slug                  String?  @unique
  playerName            String?
  team                  String?
  cardNumber            String?
  variant               String?  // Basic variant name (e.g., "Refractor", "Chrome")

  // Enhanced parallel/variation detection fields
  parallelType          String?  // Specific parallel type (e.g., "Gold Refractor", "Red Wave")
  serialNumber          String?  // Serial number if numbered (e.g., "123/299")
  isNumbered            Boolean  @default(false)
  printRun              Int?     // Total print run (e.g., 299 for /299)
  numbered              String?  // Display string for numbering (e.g., "1 of 1", "/99", "/199") - separated from parallelType
  rarity                String?  // Rarity level (base, rare, super_rare, ultra_rare, one_of_one)
  finish                String?  // Card finish (refractor, chrome, matte, glossy, holographic)
  hasAutograph          Boolean  @default(false)
  hasMemorabilia        Boolean  @default(false)
  specialFeatures       String[] // Array of special features (rookie, insert, short_print, etc.)
  colorVariant          String?  // Color designation (gold, red, blue, green, orange, etc.)

  // OCR and detection metadata
  detectionConfidence   Int?     // AI confidence score (0-100)
  detectionMethods      String[] // Methods used (ocr, visual, ai_analysis)
  detectedText          String?  // Raw OCR text for reference

  // Images
  imageFront            String?  // Front image URL
  imageBack             String?  // Back image URL

  // Admin notes
  footyNotes            String?  @db.Text // Internal notes about this card

  setId                 String
  set                   Set      @relation(fields: [setId], references: [id], onDelete: Cascade)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  posts                 Post[]   // Posts that reference this card
  images                Image[]
}

model Post {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  content     String
  excerpt     String?
  type        PostType
  published   Boolean     @default(false)
  releaseId   String?
  release     Release?    @relation(fields: [releaseId], references: [id])
  setId       String?
  set         Set?        @relation(fields: [setId], references: [id])
  cardId      String?
  card        Card?       @relation(fields: [cardId], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  authorId    String      // References neon_auth.admin_users.id (not enforced by FK)
  images      Image[]
  sourceDocuments PostSourceDocument[]
}

// Unified image model for all entities (Release, Set, Card, Post)
model Image {
  id        String   @id @default(cuid())
  url       String
  caption   String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  // Optional foreign keys - one of these will be set
  releaseId String?
  release   Release? @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  setId     String?
  set       Set?     @relation(fields: [setId], references: [id], onDelete: Cascade)

  cardId    String?
  card      Card?    @relation(fields: [cardId], references: [id], onDelete: Cascade)

  postId    String?
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
}

enum PostType {
  NEWS       // News article
  REVIEW     // Product review
  GUIDE      // How-to or buying guide
  ANALYSIS   // Market analysis or trends
  GENERAL    // General content
}

// Source documents used for content creation (sell sheets, checklists, etc.)
model SourceDocument {
  id              String   @id @default(cuid())

  // File information
  filename        String   // Original filename
  displayName     String   // User-friendly name (editable)
  blobUrl         String   // Vercel Blob storage URL
  mimeType        String   // e.g., "application/pdf", "image/jpeg"
  fileSize        Int      // Size in bytes

  // Classification
  documentType    DocumentType // SELL_SHEET, CHECKLIST, PRESS_RELEASE, etc.
  tags            String[] // Searchable tags (e.g., ["2024", "Topps", "Chrome"])

  // Content extraction
  extractedText   String?  @db.Text // OCR/extracted text for search

  // Metadata
  uploadedById    String   // References neon_auth.admin_users.id
  uploadedAt      DateTime @default(now())
  lastUsedAt      DateTime? // Last time doc was linked to content
  usageCount      Int      @default(0) // How many times it's been used

  // Notes
  description     String?  @db.Text // Admin notes about the document

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  releases        ReleaseSourceDocument[]
  posts           PostSourceDocument[]
}

enum DocumentType {
  SELL_SHEET       // Product sell sheets
  CHECKLIST        // Card checklists
  PRESS_RELEASE    // Official press releases
  PRICE_GUIDE      // Pricing information
  IMAGE            // Reference images
  OTHER            // Other document types
}

// Links source documents to releases
model ReleaseSourceDocument {
  id              String          @id @default(cuid())
  releaseId       String
  release         Release         @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  documentId      String
  document        SourceDocument  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Context for how this doc was used
  usageContext    String?         // e.g., "Used for set descriptions", "Used for card list"
  linkedAt        DateTime        @default(now())
  linkedById      String          // Who linked it

  @@unique([releaseId, documentId])
}

// Links source documents to posts
model PostSourceDocument {
  id              String          @id @default(cuid())
  postId          String
  post            Post            @relation(fields: [postId], references: [id], onDelete: Cascade)
  documentId      String
  document        SourceDocument  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Context for how this doc was used
  usageContext    String?         // e.g., "Source for market analysis"
  linkedAt        DateTime        @default(now())
  linkedById      String          // Who linked it

  @@unique([postId, documentId])
}
