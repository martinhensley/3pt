// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Manufacturer {
  id        String    @id @default(cuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  releases  Release[]
}

model Release {
  id             String          @id @default(cuid())
  name           String
  year           String?
  slug           String          @unique
  description    String?         @db.Text // Legacy field - use review instead
  review         String?         @db.Text // Footy's review of the release
  reviewDate     DateTime?       // Date the review was written or last updated
  releaseDate    String?         // Official release date as free-form string (e.g., "May 4, 2025" or "1978")
  postDate       DateTime?       // Date for chronological ordering (auto-populated from releaseDate or manually set)

  // Source files used for AI analysis
  sellSheetText  String?         @db.Text // Extracted text from sell sheets for AI description generation
  sourceFiles    Json?           // Array of {url: string, type: string, filename: string} for uploaded PDFs/images

  manufacturerId String
  manufacturer   Manufacturer    @relation(fields: [manufacturerId], references: [id], onDelete: Cascade)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  sets           Set[]
  posts          Post[]          // Posts that reference this release
  images         Image[]         // Direct relationship with type field
  sourceDocuments SourceDocument[] // Direct relationship with entityType field
}

model Set {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique // URL-friendly slug - required for public access
  type        SetType  @default(Base) // Base, Autograph, Memorabilia, or Insert
  releaseId   String
  release     Release  @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  totalCards  String?
  printRun    Int?     // Standard print run for this set (e.g., 99 for "/99" parallels, null for unlimited base sets)
  description String?  // Optional description for this set

  // Source data for regeneration and reference
  sourceText  String?  @db.Text // Original pasted checklist text

  // Parallel identification
  isParallel  Boolean  @default(false) // True if this is a parallel set (identified by naming convention)
  baseSetSlug String?  // Reference to the base set's slug (for parallels only)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  cards       Card[]
  posts       Post[]   // Posts that reference this set
  images      Image[]  // Direct relationship with type field
}

enum SetType {
  Base
  Autograph
  Memorabilia
  Insert
}

model Card {
  id                    String   @id @default(cuid())
  slug                  String?  @unique
  playerName            String?
  team                  String?
  cardNumber            String?
  variant               String?  // Basic variant name (e.g., "Refractor", "Chrome")

  // Enhanced parallel/variation detection fields
  parallelType          String?  // Specific parallel type (e.g., "Gold Refractor", "Red Wave")
  serialNumber          String?  // Serial number if numbered (e.g., "123/299")
  isNumbered            Boolean  @default(false)
  printRun              Int?     // Total print run (e.g., 299 for /299)
  numbered              String?  // Display string for numbering (e.g., "1 of 1", "/99", "/199") - separated from parallelType
  rarity                String?  // Rarity level (base, rare, super_rare, ultra_rare, one_of_one)
  finish                String?  // Card finish (refractor, chrome, matte, glossy, holographic)
  hasAutograph          Boolean  @default(false)
  hasMemorabilia        Boolean  @default(false)
  specialFeatures       String[] // Array of special features (rookie, insert, short_print, etc.)
  colorVariant          String?  // Color designation (gold, red, blue, green, orange, etc.)

  // OCR and detection metadata
  detectionConfidence   Int?     // AI confidence score (0-100)
  detectionMethods      String[] // Methods used (ocr, visual, ai_analysis)
  detectedText          String?  // Raw OCR text for reference

  // Images
  imageFront            String?  // Front image URL
  imageBack             String?  // Back image URL

  // Admin notes
  footyNotes            String?  @db.Text // Internal notes about this card

  setId                 String
  set                   Set      @relation(fields: [setId], references: [id], onDelete: Cascade)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  posts                 Post[]   // Posts that reference this card
  images                Image[]  // Direct relationship with type field
}

model Post {
  id          String      @id @default(cuid())
  title       String
  slug        String      @unique
  content     String
  excerpt     String?
  type        PostType
  published   Boolean     @default(false)
  postDate    DateTime?   // Date for chronological ordering (defaults to createdAt, can be backdated)
  releaseId   String?
  release     Release?    @relation(fields: [releaseId], references: [id])
  setId       String?
  set         Set?        @relation(fields: [setId], references: [id])
  cardId      String?
  card        Card?       @relation(fields: [cardId], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  authorId    String      // References neon_auth.admin_users.id (not enforced by FK)
  images      Image[]     // Direct relationship with type field
  sourceDocuments SourceDocument[] // Direct relationship with entityType field
}

// Unified image model - direct foreign keys with type field
model Image {
  id        String    @id @default(cuid())
  url       String
  caption   String?
  order     Int       @default(0)
  type      ImageType // What this image belongs to
  createdAt DateTime  @default(now())

  // Foreign keys - only one will be set based on type
  releaseId String?
  release   Release?  @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  setId     String?
  set       Set?      @relation(fields: [setId], references: [id], onDelete: Cascade)

  cardId    String?
  card      Card?     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  postId    String?
  post      Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
}

enum ImageType {
  RELEASE    // Release product image
  SET        // Set/insert image
  CARD       // Individual card image
  POST       // Post/article image
}

enum PostType {
  NEWS       // News article
  REVIEW     // Product review
  GUIDE      // How-to or buying guide
  ANALYSIS   // Market analysis or trends
  GENERAL    // General content
}

// Source documents used for content creation (sell sheets, checklists, etc.)
model SourceDocument {
  id              String       @id @default(cuid())

  // File information
  filename        String       // Original filename
  displayName     String       // User-friendly name (editable)
  blobUrl         String       // Vercel Blob storage URL
  mimeType        String       // e.g., "application/pdf", "image/jpeg"
  fileSize        Int          // Size in bytes

  // Classification
  documentType    DocumentType // SELL_SHEET, CHECKLIST, PRESS_RELEASE, etc.
  entityType      SourceDocumentEntityType // What this document belongs to
  tags            String[]     // Searchable tags (e.g., ["2024", "Topps", "Chrome"])

  // Content extraction
  extractedText   String?      @db.Text // OCR/extracted text for search

  // Metadata
  uploadedById    String       // References neon_auth.admin_users.id
  uploadedAt      DateTime     @default(now())
  lastUsedAt      DateTime?    // Last time doc was linked to content
  usageCount      Int          @default(0) // How many times it's been used
  usageContext    String?      // e.g., "Used for set descriptions"

  // Notes
  description     String?      @db.Text // Admin notes about the document

  // Timestamps
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Foreign keys - only one will be set based on entityType
  releaseId       String?
  release         Release?     @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  postId          String?
  post            Post?        @relation(fields: [postId], references: [id], onDelete: Cascade)
}

enum SourceDocumentEntityType {
  RELEASE  // Document for a release
  POST     // Document for a post/article
}

enum DocumentType {
  SELL_SHEET       // Product sell sheets
  CHECKLIST        // Card checklists
  PRESS_RELEASE    // Official press releases
  PRICE_GUIDE      // Pricing information
  IMAGE            // Reference images
  OTHER            // Other document types
}

// Junction tables removed - using direct foreign keys with type fields instead
